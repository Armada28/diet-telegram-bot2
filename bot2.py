import asyncio
import os
import random
import logging
import signal
import sys

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏–Ω–≥–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (Railway)
TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    logger.error("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
    sys.exit(1)

bot = Bot(token=TOKEN)
dp = Dispatcher()

# ‚îÄ‚îÄ‚îÄ –í–ê–õ–ï–†–ò–ù–´ –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ï –û–¢–í–ï–¢–´ ‚îÄ‚îÄ‚îÄ
personal_roasts = {
    "—Å–∞—à–∞": [
        "–°–∞—à–∞, –í–∞–ª–µ—Ä–∞ –≥–æ–≤–æ—Ä–∏—Ç: –∏–¥–∏ –Ω–∞—Ö—É–π, –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –ø–æ–∫–∞ –º–æ–∑–≥–∏ –Ω–µ –æ—Ç—Ä–∞—Å—Ç–∏—à—å.",
        "–°–∞—à–µ –æ—Ç –í–∞–ª–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π: –Ω–∞—Ö—É–π –ø–æ—à—ë–ª, –±—Ä–∞—Ç–∏—à–∫–∞ ‚ù§Ô∏èüñï",
        "–í–∞–ª–µ—Ä–∞ –°–∞—à–µ: –∏–¥–∏ –Ω–∞—Ö—É–π, –∏ –ø—Ä–∏—Ö–≤–∞—Ç–∏ —Å–≤–æ–∏ —Ç—É–ø—ã–µ —à—É—Ç–∫–∏ —Å —Å–æ–±–æ–π.",
        "–°–∞—à–∞, –í–∞–ª–µ—Ä–∞ —É–∂–µ —É—Å—Ç–∞–ª –æ—Ç —Ç–µ–±—è ‚Äî –Ω–∞—Ö—É–π –∏–¥–∏, –±—ã—Å—Ç—Ä–æ.",
    ],
    "—Å–∞—à—É": [  # –≤–∞—Ä–∏–∞—Ü–∏–∏ –∏–º–µ–Ω–∏
        "–°–∞—à—É –í–∞–ª–µ—Ä–∞ –ø–æ—Å–ª–∞–ª –Ω–∞—Ö—É–π. –õ–µ—Ç–∏, –ø—Ç–∏—á–∫–∞ üñï",
        "–°–∞—à—É ‚Äî –Ω–∞—Ö—É–π. –í–∞–ª–µ—Ä–∞ —Å–∫–∞–∑–∞–ª.",
        "–°–∞—à—É –í–∞–ª–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª –≤ –ø–æ–ª—ë—Ç –Ω–∞—Ö—É–π. –ë–µ–∑ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞.",
    ],
    "–∏–≥–æ—Ä—å": [
        "–ò–≥–æ—Ä—å, –í–∞–ª–µ—Ä–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç: –Ω–∞—Ö—É–π —Ç–µ–±–µ –¥–æ—Ä–æ–≥–∞, –Ω–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π—Å—è.",
        "–í–∞–ª–µ—Ä–∞ –ò–≥–æ—Ä—é: –ø–æ—à—ë–ª –Ω–∞—Ö—É–π, –∏ –¥–≤–µ—Ä—å –∑–∞ —Å–æ–±–æ–π –∑–∞–∫—Ä–æ–π –Ω–∞—Ö—É–π.",
        "–ò–≥–æ—Ä—å, –í–∞–ª–µ—Ä–∞ —É—Å—Ç–∞–ª ‚Äî –∏–¥–∏ –Ω–∞—Ö—É–π —Ç–∏—Ö–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞.",
        "–ò–≥–æ—Ä—å ‚Äî –Ω–∞—Ö—É–π. –í–∞–ª–µ—Ä–∞ –Ω–µ —à—É—Ç–∏—Ç.",
    ],
    "–∏–≥–æ—Ä—è": [  # –≤–∞—Ä–∏–∞—Ü–∏–∏
        "–ò–≥–æ—Ä—è –í–∞–ª–µ—Ä–∞ –ø–æ—Å–ª–∞–ª –Ω–∞—Ö—É–π. –õ–æ–≤–∏ –º–æ–º–µ–Ω—Ç üñï",
        "–ò–≥–æ—Ä—è ‚Äî –Ω–∞—Ö—É–π. –í–∞–ª–µ—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª.",
        "–ò–≥–æ—Ä—è –í–∞–ª–µ—Ä–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª –≤ –æ—Ç–ø—É—Å–∫ –Ω–∞—Ö—É–π. –ë–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞.",
    ],
}

# ‚îÄ‚îÄ‚îÄ –•–ï–ù–î–õ–ï–† –í–ê–õ–ï–†–´ ‚îÄ‚îÄ‚îÄ
@dp.message(F.text.lower().contains("–≤–∞–ª–µ—Ä–∞ –ø–æ—à–ª–∏ –Ω–∞—Ö—É–π"))
async def valera_send_to_hui(message: types.Message):
    text = message.text.lower()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–ø–æ–º—è–Ω—É—Ç–æ –ª–∏ –∏–º—è –°–∞—à–∏ –∏–ª–∏ –ò–≥–æ—Ä—è
    mentioned = None
    if any(word in text for word in ["—Å–∞—à–∞", "—Å–∞—à—É", "—Å–∞—à–µ", "—Å–∞—à—É"]):
        mentioned = "—Å–∞—à–∞"
    elif any(word in text for word in ["–∏–≥–æ—Ä—å", "–∏–≥–æ—Ä—è", "–∏–≥–æ—Ä–µ", "–∏–≥–æ—Ä—é"]):
        mentioned = "–∏–≥–æ—Ä—å"

    # –ï—Å–ª–∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç ‚Äî –º–æ–ª—á–∏–º
    if not mentioned:
        return

    # 10% —à–∞–Ω—Å –æ—Ç–∫–∞–∑–∞
    if random.random() < 0.10:
        await message.reply(random.choice([
            "–í–∞–ª–µ—Ä–∞ —Å–µ–≥–æ–¥–Ω—è –¥–æ–±—Ä—ã–π. –ù–∏–∫–æ–≥–æ –Ω–∞—Ö—É–π –Ω–µ –ø–æ—Å—ã–ª–∞–µ—Ç üòá",
            "–í–∞–ª–µ—Ä–∞ –≤ –æ—Ç–ø—É—Å–∫–µ. –ò–¥–∏—Ç–µ –Ω–∞—Ö—É–π —Å–∞–º–∏.",
            "–í–∞–ª–µ—Ä–∞ —É—Å—Ç–∞–ª. –ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –∫—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–π –≤–∞—Å –ø–æ—à–ª—ë—Ç.",
        ]))
        return

    # –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
    if random.random() < 0.7:
        reply = random.choice(personal_roasts[mentioned])
    else:
        # –∏–Ω–æ–≥–¥–∞ –æ–±—â–∏–π –∂—ë—Å—Ç–∫–∏–π
        reply = random.choice([
            f"{mentioned.capitalize()}, –í–∞–ª–µ—Ä–∞ —Å–∫–∞–∑–∞–ª: –Ω–∞—Ö—É–π –ø–æ—à—ë–ª, –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è.",
            f"–í–∞–ª–µ—Ä–∞: {mentioned.capitalize()} ‚Äî –Ω–∞—Ö—É–π. –ë–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.",
            f"{mentioned.capitalize()} –ø–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–∏–ª–µ—Ç –Ω–∞—Ö—É–π –æ—Ç –í–∞–ª–µ—Ä—ã üñï",
        ])

    await message.reply(reply)

# ‚îÄ‚îÄ‚îÄ /start –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚îÄ‚îÄ‚îÄ
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.reply("–í–∞–ª–µ—Ä–∞ –Ω–∞ –ø–æ—Å—Ç—É üñï\n–ü–∏—à–∏: –≤–∞–ª–µ—Ä–∞ –ø–æ—à–ª–∏ –Ω–∞—Ö—É–π —Å–∞—à–∞ / –∏–≥–æ—Ä—è")

# ‚îÄ‚îÄ‚îÄ GRACEFUL SHUTDOWN ‚îÄ‚îÄ‚îÄ
async def shutdown():
    logger.info("–ü–æ–ª—É—á–µ–Ω SIGTERM, graceful shutdown...")
    await bot.session.close()
    sys.exit(0)

def handle_sigterm(signum, frame):
    asyncio.create_task(shutdown())

signal.signal(signal.SIGTERM, handle_sigterm)

# ‚îÄ‚îÄ‚îÄ –ó–ê–ü–£–°–ö ‚îÄ‚îÄ‚îÄ
async def main():
    logger.info("–í–∞–ª–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
