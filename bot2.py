import asyncio
import os
import random
import logging
import signal
import sys

from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏–Ω–≥–∞
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (Railway)
TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    logger.error("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
    sys.exit(1)

# ID —Ç–≤–æ–µ–π –≥—Ä—É–ø–ø—ã
ALLOWED_GROUP_ID = -4894395021

bot = Bot(token=TOKEN)
dp = Dispatcher()

# ‚îÄ‚îÄ‚îÄ –í–ê–õ–ï–†–ò–ù–´ –û–¢–í–ï–¢–´ ‚îÄ‚îÄ‚îÄ
valera_roasts = [
    "–í–∞–ª–µ—Ä–∞ —É—Å–ª—ã—à–∞–ª. –í—Å—ë, –ø–æ—à–ª–∏ –Ω–∞—Ö—É–π, –ø–∏–∑–¥–µ—Ü –≤–∞–º üñï",
    "–í–∞–ª–µ—Ä–∞: ¬´–ü–æ—à–ª–∏ –Ω–∞—Ö—É–π, –¥–æ —Å–≤–∏–¥–∞–Ω–∏—è¬ª üëãüñï",
    "–ü–æ—à–ª–∏ –Ω–∞—Ö—É–π, –í–∞–ª–µ—Ä–∞ —É–∂–µ —Ç–∞—â–∏—Ç –≤–∞—Å –∫ –≤—ã—Ö–æ–¥—É –∑–∞ —à–∫–∏—Ä–∫—É",
    "–í–∞–ª–µ—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: –Ω–∞—Ö—É–π. –ê–ø–µ–ª–ª—è—Ü–∏—è –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è.",
    "–í–∞–ª–µ—Ä–∞ –¥–æ—Å—Ç–∞–ª –ª–æ–ø–∞—Ç—É –∏ —Ä–æ–µ—Ç –≤–∞–º —è–º—É –Ω–∞—Ö—É–π. –ì–ª—É–±–∏–Ω–∞ ‚Äî –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å.",
    "–í–∞–ª–µ—Ä–∞: ¬´–Ø –≤–∞—Å –Ω–∞—Ö—É–π –ø–æ—Å–ª–∞–ª, –∞ –≤—ã –≤—Å—ë –µ—â—ë —Ç—É—Ç —Ç–æ—Ä—á–∏—Ç–µ? –£–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ.¬ª",
    "–í–∞–ª–µ—Ä–∞ –≤—ã–ø–∏—Å–∞–ª –≤–∞–º –±–∏–ª–µ—Ç –≤ –æ–¥–∏–Ω –∫–æ–Ω–µ—Ü ‚Äî –Ω–∞—Ö—É–π. Bon voyage üñï‚úàÔ∏è",
    "–í–∞–ª–µ—Ä–∞ –≤–∫–ª—é—á–∏–ª —Ç—É—Ä–±–æ-—Ä–µ–∂–∏–º ¬´–ø–æ—à–ª–∏ –Ω–∞—Ö—É–π¬ª. –î–µ—Ä–∂–∏—Ç–µ—Å—å –∑–∞ –∂–æ–ø—ã.",
    "–í–∞–ª–µ—Ä–∞ —Ä–∞–∑–æ–∑–ª–∏–ª—Å—è. –í—Å–µ–º –Ω–∞—Ö—É–π. –ü–æ –æ—á–µ—Ä–µ–¥–∏. –° —Ä–∞–∑–≥–æ–Ω–∞.",
    "–í–∞–ª–µ—Ä–∞: ¬´–í—Å—ë, –Ω–∞—Ö—É–π –≤—Å—é –≤–∞—à—É –∫–æ–º–ø–∞—à–∫—É. –ì—Ä—É–ø–ø–æ–≤–æ–π –ø–æ–ª—ë—Ç –±–µ–∑ –ø–∞—Ä–∞—à—é—Ç–æ–≤.¬ª",
    "–í–∞–ª–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª —è–¥–µ—Ä–∫—É. –ù–∞—Ö—É–π –ª–µ—Ç—è—Ç –≤—Å–µ, –≤–∫–ª—é—á–∞—è —Å—Ç—É–ª—å—è –∏ –ø–∏–≤–æ.",
]

personal_roasts = {
    "—Å–∞—à—É": [
        "–°–∞—à–∞, –í–∞–ª–µ—Ä–∞ –≥–æ–≤–æ—Ä–∏—Ç: –∏–¥–∏ –Ω–∞—Ö—É–π, –∏ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –ø–æ–∫–∞ –º–æ–∑–≥–∏ –Ω–µ –æ—Ç—Ä–∞—Å—Ç–∏—à—å.",
        "–°–∞—à–µ –æ—Ç –í–∞–ª–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π: –Ω–∞—Ö—É–π –ø–æ—à—ë–ª, –±—Ä–∞—Ç–∏—à–∫–∞ ‚ù§Ô∏èüñï",
        "–í–∞–ª–µ—Ä–∞ –°–∞—à–µ: –∏–¥–∏ –Ω–∞—Ö—É–π, –∏ –ø—Ä–∏—Ö–≤–∞—Ç–∏ —Å–≤–æ–∏ —Ç—É–ø—ã–µ —à—É—Ç–∫–∏ —Å —Å–æ–±–æ–π.",
    ],
    "–∏–≥–æ—Ä—è": [
        "–ò–≥–æ—Ä—å, –í–∞–ª–µ—Ä–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç: –Ω–∞—Ö—É–π —Ç–µ–±–µ –¥–æ—Ä–æ–≥–∞, –Ω–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π—Å—è.",
        "–í–∞–ª–µ—Ä–∞ –ò–≥–æ—Ä—é: –ø–æ—à—ë–ª –Ω–∞—Ö—É–π, –∏ –¥–≤–µ—Ä—å –∑–∞ —Å–æ–±–æ–π –∑–∞–∫—Ä–æ–π –Ω–∞—Ö—É–π.",
        "–ò–≥–æ—Ä—å, –í–∞–ª–µ—Ä–∞ —É—Å—Ç–∞–ª ‚Äî –∏–¥–∏ –Ω–∞—Ö—É–π —Ç–∏—Ö–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —à—É–º–∞.",
    ],
    # –î–æ–±–∞–≤—å –¥—Ä—É–≥–∏—Ö –¥—Ä—É–∑–µ–π —Å—é–¥–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
}

# ‚îÄ‚îÄ‚îÄ –•–ï–ù–î–õ–ï–† –í–ê–õ–ï–†–´ ‚îÄ‚îÄ‚îÄ
@dp.message(F.chat.id == ALLOWED_GROUP_ID)
@dp.message(F.text.lower().contains("–≤–∞–ª–µ—Ä–∞ –ø–æ—à–ª–∏"))
@dp.message(F.text.lower().contains("–≤–∞–ª–µ—Ä–∞ –ø–æ—à–ª–∏ –Ω–∞ —Ö—É–π"))
async def valera_send_to_hui(message: types.Message):
    text = message.text.lower()

    # 10% —à–∞–Ω—Å –æ—Ç–∫–∞–∑–∞ (–¥–ª—è —Å–º–µ—Ö–∞)
    if random.random() < 0.10:
        await message.reply(random.choice([
            "–í–∞–ª–µ—Ä–∞ —Å–µ–≥–æ–¥–Ω—è –¥–æ–±—Ä—ã–π. –ù–∏–∫–æ–≥–æ –Ω–∞—Ö—É–π –Ω–µ –ø–æ—Å—ã–ª–∞–µ—Ç üòá",
            "–í–∞–ª–µ—Ä–∞ –≤ –æ—Ç–ø—É—Å–∫–µ. –ò–¥–∏—Ç–µ –Ω–∞—Ö—É–π —Å–∞–º–∏.",
            "–í–∞–ª–µ—Ä–∞ —É—Å—Ç–∞–ª. –ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –∫—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–π –≤–∞—Å –ø–æ—à–ª—ë—Ç.",
        ]))
        return

    mentioned = None
    for name in personal_roasts:
        if name in text:
            mentioned = name
            break

    if mentioned:
        if random.random() < 0.7:
            reply = random.choice(personal_roasts[mentioned])
        else:
            reply = random.choice(valera_roasts)
    elif "–≤—Å–µ—Ö" in text or "–∏—Ö –≤—Å–µ—Ö" in text or "–≤—Å—é" in text:
        reply = random.choice(valera_roasts[-3:] + valera_roasts)  # —á–∞—â–µ —è–¥–µ—Ä–Ω—ã–µ
    else:
        reply = random.choice(valera_roasts)

    await message.reply(reply)

# ‚îÄ‚îÄ‚îÄ /start –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚îÄ‚îÄ‚îÄ
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    if message.chat.id == ALLOWED_GROUP_ID:
        await message.reply("–í–∞–ª–µ—Ä–∞ –Ω–∞ –ø–æ—Å—Ç—É üñï\n–ü–∏—à–∏: –≤–∞–ª–µ—Ä–∞ –ø–æ—à–ª–∏ –Ω–∞ —Ö—É–π [–∫–æ–≥–æ-—Ç–æ]")
    else:
        await message.reply("–≠—Ç–æ—Ç –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ. –ò–¥–∏ –Ω–∞—Ö—É–π –æ—Ç—Å—é–¥–∞ üòè")

# ‚îÄ‚îÄ‚îÄ GRACEFUL SHUTDOWN ‚îÄ‚îÄ‚îÄ
async def shutdown():
    logger.info("–ü–æ–ª—É—á–µ–Ω SIGTERM, graceful shutdown...")
    await bot.session.close()
    sys.exit(0)

def handle_sigterm(signum, frame):
    asyncio.create_task(shutdown())

signal.signal(signal.SIGTERM, handle_sigterm)

# ‚îÄ‚îÄ‚îÄ –ó–ê–ü–£–°–ö ‚îÄ‚îÄ‚îÄ
async def main():
    logger.info("–í–∞–ª–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
